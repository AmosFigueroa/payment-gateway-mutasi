<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Dashboard - Wago Payment</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co.com/vCmXfR9s/logo-wagopay-1-2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: #334155; min-height: 100vh; }
        .modern-card { background: #ffffff; border-radius: 2.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
        .input-field { width: 100%; padding: 12px 16px; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; font-size: 0.875rem; transition: all 0.2s; color: #334155; font-weight: 600; }
        .btn-main { background: #0f172a; color: white; padding: 12px 24px; border-radius: 1rem; font-weight: 700; transition: all 0.2s; width: 100%; }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; }
        .hidden { display: none; }
    </style>
</head>
<body class="flex items-center justify-center p-4 bg-slate-900">

    <div id="login-overlay" class="fixed inset-0 z-50 bg-slate-950 flex items-center justify-center p-4">
        <div class="modern-card p-8 w-full max-w-[400px] text-center">
            <div class="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6"><img src="https://i.ibb.co.com/vCmXfR9s/logo-wagopay-1-2.png" class="w-12 h-12 object-contain"></div>
            <h2 class="text-2xl font-bold text-slate-900 mb-6">Login Merchant</h2>
            
            <input type="email" id="login-email" class="input-field mb-4" placeholder="Email Anda">
            <input type="password" id="login-pin" class="input-field mb-6 text-center tracking-widest" placeholder="PIN (6 Digit)" maxlength="6">
            
            <button onclick="doLogin()" class="btn-main mb-4">MASUK</button>
            <div class="flex justify-between text-sm font-bold text-slate-400">
                <button onclick="toggleRegister(true)" class="text-indigo-600">Daftar Baru</button>
            </div>
        </div>
    </div>

    <div id="register-overlay" class="hidden fixed inset-0 z-50 bg-slate-950 flex items-center justify-center p-4">
        <div class="modern-card p-8 w-full max-w-[400px] text-center">
            <h2 class="text-xl font-bold text-slate-900 mb-4">Daftar Mitra</h2>
            <input type="text" id="reg-store" class="input-field mb-3" placeholder="Nama Toko">
            <input type="email" id="reg-email" class="input-field mb-3" placeholder="Email Aktif">
            <input type="text" id="reg-wa" class="input-field mb-3" placeholder="No WhatsApp">
            <input type="password" id="reg-pin" class="input-field mb-6 text-center tracking-widest" placeholder="Buat PIN (6 Digit)" maxlength="6">
            
            <button onclick="doRegister()" class="btn-main mb-4 bg-emerald-600">DAFTAR SEKARANG</button>
            <button onclick="toggleRegister(false)" class="text-sm font-bold text-slate-400">Kembali ke Login</button>
        </div>
    </div>

    <div id="main-dashboard" class="w-full max-w-xl hidden">
        <div class="modern-card p-8 mb-6 relative overflow-hidden bg-indigo-600 text-white">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-indigo-200 text-sm font-bold mb-1">Halo, <span id="dash-store">Toko</span></p>
                    <h2 class="text-4xl font-extrabold" id="dash-balance">Rp 0</h2>
                </div>
                <button onclick="logout()" class="bg-white/20 p-2 rounded-lg text-xs font-bold">LOGOUT</button>
            </div>
            <button onclick="refreshBalance()" class="mt-4 text-xs bg-black/20 px-3 py-1 rounded-full flex items-center gap-2">ðŸ”„ Refresh Saldo</button>
        </div>

        <div class="modern-card p-8">
            <h3 class="font-bold text-lg mb-4">Buat Tagihan Baru</h3>
            <input type="text" id="itemName" class="input-field mb-3" placeholder="Nama Barang">
            <input type="number" id="itemPrice" class="input-field mb-3" placeholder="Harga (Rp)">
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <input type="text" id="custWa" class="input-field" placeholder="WA Pembeli">
                <input type="email" id="custEmail" class="input-field" placeholder="Email Pembeli">
            </div>

            <button onclick="createInvoice()" class="btn-main">BUAT LINK BAYAR</button>
            
            <div id="result-area" class="hidden mt-6 p-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                <p class="text-xs text-slate-500 font-bold mb-2">Link Pembayaran:</p>
                <textarea id="resultUrl" class="input-field h-20 text-xs mb-2" readonly></textarea>
                <button onclick="copyLink()" class="btn-main bg-slate-800 py-2 text-sm">Salin Link</button>
            </div>
        </div>
    </div>

    <script>
        // Data User yang sedang login (disimpan di memori browser sementara)
        let currentUser = null; 

        // --- AUTH SYSTEM ---
        
        function toggleRegister(show) {
            document.getElementById('login-overlay').classList.toggle('hidden', show);
            document.getElementById('register-overlay').classList.toggle('hidden', !show);
        }

        async function doRegister() {
            const store = document.getElementById('reg-store').value;
            const email = document.getElementById('reg-email').value;
            const wa = document.getElementById('reg-wa').value;
            const pin = document.getElementById('reg-pin').value;

            if(!store || !email || !pin) return alert("Lengkapi data!");

            try {
                const res = await fetch('/api/user', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'register', store, email, wa, pin })
                });
                const data = await res.json();
                
                if(res.ok) {
                    alert("Berhasil! Silakan Login.");
                    toggleRegister(false);
                    // Kirim notif sambutan (Optional)
                    fetch('/api/send-notif', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'REGISTER', data: {store, email, wa} }) });
                } else {
                    alert(data.error);
                }
            } catch(e) { alert("Error koneksi"); }
        }

        async function doLogin() {
            const email = document.getElementById('login-email').value;
            const pin = document.getElementById('login-pin').value;

            try {
                const res = await fetch('/api/user', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'login', email, pin })
                });
                const resp = await res.json();

                if(res.ok) {
                    currentUser = resp.data; // Simpan data user
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('main-dashboard').classList.remove('hidden');
                    updateUI();
                } else {
                    alert(resp.error);
                }
            } catch(e) { alert("Gagal login: " + e.message); }
        }

        function updateUI() {
            if(!currentUser) return;
            document.getElementById('dash-store').innerText = currentUser.store;
            document.getElementById('dash-balance').innerText = "Rp " + currentUser.balance.toLocaleString('id-ID');
        }

        async function refreshBalance() {
            if(!currentUser) return;
            try {
                const res = await fetch('/api/user', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'check_balance', email: currentUser.email })
                });
                const data = await res.json();
                if(data.balance !== undefined) {
                    currentUser.balance = data.balance;
                    updateUI();
                }
            } catch(e) {}
        }

        function logout() {
            currentUser = null;
            location.reload();
        }

        // --- INVOICE SYSTEM ---

        async function createInvoice() {
            if(!currentUser) return;

            const item = document.getElementById('itemName').value;
            const price = document.getElementById('itemPrice').value;
            const wa = document.getElementById('custWa').value;
            const email = document.getElementById('custEmail').value;

            if(!item || !price) return alert("Isi data barang!");

            // Generate Link
            // Disini kita kirim 'items' encode base64 ke frontend index.html
            // Tapi untuk backend, kita akan kirim data ke API checkout nanti
            const items = [{n: item, p: parseInt(price)}];
            const itemsEncoded = btoa(JSON.stringify(items));
            const refId = "INV-" + Date.now();
            
            // Generate URL Frontend
            const params = new URLSearchParams({
                store: currentUser.store,
                price: price,
                items: itemsEncoded,
                prod: item,
                ref_id: refId,
                wa: wa, email: email
            });
            const finalUrl = window.location.origin + "/?" + params.toString();

            document.getElementById('resultUrl').value = finalUrl;
            document.getElementById('result-area').classList.remove('hidden');

            // SIMPAN KE DATABASE (PENTING AGAR SALDO MASUK KE USER INI)
            await fetch('/api/checkout', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    merchant_email: currentUser.email, // <-- INI YANG BIKIN SALDO MASUK KE USER
                    product_name: item,
                    price: price,
                    customer_contact: wa,
                    customer_email: email,
                    ref_id: refId,
                    method: 'qris'
                })
            });
        }

        function copyLink() {
            const copyText = document.getElementById("resultUrl");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("Link tersalin!");
        }
    </script>
</body>
</html>
