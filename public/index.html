<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wago Payment ID</title>
    <link id="dynamic-favicon" rel="icon" type="image/png" href="https://i.ibb.co.com/vCmXfR9s/logo-wagopay-1-2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        if (window.location.hostname === 'create-invoiceku.vercel.app') window.location.replace('/create-invoice.html');
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: #334155; height: 100dvh; overflow: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .success-pop { animation: successPop 0.5s forwards; }
        @keyframes successPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="flex items-center justify-center">
    <div id="main-container" class="w-full h-[100dvh] sm:max-w-[480px] sm:h-[90vh] glass-panel sm:rounded-[2.5rem] shadow-2xl overflow-hidden relative flex flex-col sm:border sm:border-white/40">
        <header class="flex-none px-6 py-4 bg-white/80 border-b border-slate-100 flex items-center justify-between backdrop-blur-xl z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-xl shadow-md p-1"><img src="https://i.ibb.co.com/vCmXfR9s/logo-wagopay-1-2.png" class="w-full h-full object-contain"></div>
                <div><h1 class="font-bold text-lg text-slate-900">Wago Payment ID</h1><p class="text-[9px] font-bold text-emerald-700 uppercase bg-emerald-50 px-2 py-0.5 rounded-full w-fit">SECURE CHECKOUT</p></div>
            </div>
        </header>

        <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar p-4 relative bg-slate-50"></main>
        <footer id="action-area" class="flex-none p-6 bg-white border-t border-slate-100 z-20 shadow-lg"></footer>
    </div>

    <script>
        // DATA & STATE
        const bankData = [
            { id: 'bcava', name: 'Bank BCA', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Bank_Central_Asia.svg/1200px-Bank_Central_Asia.svg.png' },
            { id: 'bni', name: 'Bank BNI', logo: 'https://i.ibb.co.com/zh7hMw8z/36384348ef9d7bfff66da6da9e975d56-3072258775.png' },
            { id: 'seabank', name: 'SeaBank', logo: 'https://i.ibb.co.com/wr7QqTcx/image.png' },
            { id: 'jago', name: 'Bank Jago', logo: 'https://i.ibb.co.com/tMdwhc2v/logo-color-3719629472.png' },
            { id: 'neobank', name: 'Neo Bank', logo: 'https://i.ibb.co.com/WWB7ZSwK/image.png' }
        ];
        
        let state = { step: 1, totalAmount: 0, items: [], selectedMethod: 'qris', timeoutMinutes: 15, refId: "", activeQrisData: null };
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            state.totalAmount = parseInt(params.get('price')) || 0;
            state.refId = params.get('ref_id') || "";
            state.timeoutMinutes = parseInt(params.get('time')) || 15;

            // PARSE MULTI ITEMS
            const itemsEncoded = params.get('items');
            if (itemsEncoded) {
                try {
                    // Decode Base64 -> Parse JSON
                    const itemsJson = atob(itemsEncoded);
                    state.items = JSON.parse(itemsJson);
                } catch (e) {
                    // Fallback jika error decoding
                    state.items = [{n: params.get('prod') || "Produk", p: state.totalAmount}];
                }
            } else {
                // Single Item fallback
                state.items = [{n: params.get('prod') || "Produk", p: state.totalAmount}];
            }

            renderStep1();
        };

        window.selectMethod = (id) => { state.selectedMethod = id; updateVisual(); }

        function updateVisual() {
            // Logic ganti warna (Dark mode selection)
            document.querySelectorAll('[id^="method-"]').forEach(el => {
                el.className = "cursor-pointer relative p-3 rounded-2xl border transition-all mb-3 flex items-center gap-4 border-slate-200 bg-white hover:border-slate-300";
                el.querySelector('[id^="radio-"]').className = "w-5 h-5 rounded-full border-2 border-slate-300 bg-white";
            });
            const active = document.getElementById(`method-${state.selectedMethod}`);
            const radio = document.getElementById(`radio-${state.selectedMethod}`);
            if(active) {
                active.className = "cursor-pointer relative p-3 rounded-2xl border transition-all mb-3 flex items-center gap-4 bg-slate-800 text-white shadow-xl border-transparent";
                radio.className = "w-5 h-5 rounded-full border-2 bg-emerald-400 border-slate-800";
            }
        }

        function renderStep1() {
            // RENDER ITEM LIST
            const itemsHtml = state.items.map(i => `
                <div class="flex justify-between text-xs py-1 border-b border-dashed border-slate-100 last:border-0">
                    <span class="text-slate-600 truncate max-w-[70%]">${i.n}</span>
                    <span class="font-bold text-slate-800">${formatRupiah(i.p)}</span>
                </div>
            `).join('');

            const bankHtml = bankData.map(b => `
                <div id="method-${b.id}" onclick="selectMethod('${b.id}')" class="cursor-pointer relative p-3 rounded-2xl border mb-3 flex items-center gap-4 border-slate-200 bg-white">
                    <div class="w-10 h-10 bg-white rounded-lg p-1 border border-slate-100 flex items-center justify-center"><img src="${b.logo}" class="w-full h-full object-contain"></div>
                    <div class="flex-1"><h4 class="font-bold text-sm text-inherit">${b.name}</h4></div>
                    <div id="radio-${b.id}" class="w-5 h-5 rounded-full border-2 border-slate-300"></div>
                </div>
            `).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="px-2 pt-4 pb-20">
                    <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-200 mb-6">
                        <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Rincian Belanja</h2>
                        <div class="space-y-1 mb-3">${itemsHtml}</div>
                        <div class="flex justify-between pt-3 border-t border-slate-100">
                            <span class="text-sm font-bold text-slate-500">Total</span>
                            <span class="text-lg font-extrabold text-slate-900">${formatRupiah(state.totalAmount)}</span>
                        </div>
                    </div>
                    
                    <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">Metode Pembayaran</h2>
                    <div id="method-qris" onclick="selectMethod('qris')" class="cursor-pointer relative p-4 rounded-2xl border mb-3 flex items-center gap-4 bg-white border-slate-200">
                        <div class="w-12 h-12 bg-white p-1 rounded-xl border border-slate-100"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo_QRIS.svg/1200px-Logo_QRIS.svg.png" class="w-full h-full object-contain"></div>
                        <div class="flex-1"><h4 class="font-bold text-sm">QRIS (Otomatis)</h4><p class="text-[10px] opacity-70">GoPay, OVO, Dana, dll</p></div>
                        <div id="radio-qris" class="w-5 h-5 rounded-full border-2 border-slate-300"></div>
                    </div>
                    ${state.totalAmount >= 50000 ? bankHtml : ''}
                </div>`;
                
            document.getElementById('action-area').innerHTML = `<button onclick="processCheckout()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl active:scale-[0.98] transition-all">BAYAR SEKARANG</button>`;
            updateVisual();
        }

        async function processCheckout() {
            const btn = document.querySelector('#action-area button');
            if(state.selectedMethod !== 'qris' && !bankData.find(b => b.id === state.selectedMethod)) { alert("Pilih metode!"); return; }
            btn.innerHTML = "MEMPROSES...";
            
            try {
                const params = new URLSearchParams(window.location.search);
                const data = { 
                    product_name: state.items.length + " Items", // Backend mungkin perlu string simple
                    price: state.totalAmount, 
                    customer_contact: params.get('wa'), 
                    customer_email: params.get('email'), 
                    method: state.selectedMethod, 
                    ref_id: state.refId, 
                    notify_url: params.get('notify') 
                };
                
                const res = await fetch('/api/checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
                const d = await res.json();
                
                if(d.status === 'success') { 
                    state.totalAmount = d.total_pay; 
                    if(d.qris_meta) state.activeQrisData = d.qris_meta; // Simpan data untuk download
                    renderStep2(d); 
                } else { alert(d.error); renderStep1(); }
            } catch(e) { alert("Error koneksi"); renderStep1(); }
        }

        // --- STEP 2 (DISPLAY PAYMENT) & STEP 3 (SUCCESS) ---
        // (Gunakan logika renderStep2 dan renderStep3 yang sama seperti kode sebelumnya, 
        //  tapi pastikan menggunakan state.totalAmount yang baru dari backend)
        
        function renderStep2(apiData) {
             // ... (Kode sama dengan sebelumnya, hanya pastikan menampilkan QRIS/Bank)
             // Copy function renderStep2 dari kode sebelumnya di sini.
             // Untuk menyingkat, saya asumsikan Anda memakai logika display QRIS/Bank yang sama.
             // KUNCI: Tampilkan apiData.total_pay (Nominal Unik)
             const content = document.getElementById('app-content');
             // ... Simple display logic ...
             content.innerHTML = `<div class="text-center pt-10"><h2 class="text-2xl font-bold">Rp ${apiData.total_pay.toLocaleString('id-ID')}</h2><p>Silakan bayar sesuai nominal.</p></div>`;
             // Tambahkan Timer & Status Checker di sini...
        }
    </script>
</body>
</html>
