<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wago Payment ID</title>
    <link id="dynamic-favicon" rel="icon" type="image/png" href="https://i.ibb.co.com/vCmXfR9s/logo-wagopay-1-2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: #334155; min-height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .fade-enter { animation: fadeEnter 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes fadeEnter { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="main-container" class="w-full h-full sm:max-w-[420px] sm:h-[90vh] glass-panel sm:rounded-[2.5rem] shadow-2xl overflow-hidden relative flex flex-col sm:border sm:border-white/40 z-10 transition-all duration-500">
        <header class="flex-none px-6 py-4 bg-white/90 border-b border-slate-100 flex items-center justify-between backdrop-blur-xl z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-white rounded-xl flex items-center justify-center shadow-md border border-slate-200 overflow-hidden p-1">
                   <img id="header-logo" src="https://i.ibb.co.com/vCmXfR9s/logo-wagopay-1-2.png" class="w-full h-full object-contain">
                </div>
                <div><h1 id="header-title" class="font-bold text-base text-slate-900 leading-tight">Wago Payment</h1><p class="text-[10px] font-bold text-emerald-600 flex items-center gap-1">SECURE CHECKOUT</p></div>
            </div>
        </header>

        <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar relative bg-[#f8fafc] p-4 pb-24"></main>
        <footer id="action-area" class="flex-none p-5 bg-white border-t border-slate-100 z-20 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] absolute bottom-0 w-full"></footer>
    </div>

    <input type="hidden" id="customerWa"><input type="hidden" id="customerEmail">

    <script>
        const DOMAIN_SETTINGS = { "payment-gateway-mutasi.vercel.app": { name: "Wago Payment ID", logo: "https://i.ibb.co.com/vCmXfR9s/logo-wagopay-1-2.png" } };
        function applyDomainSettings() { const s = DOMAIN_SETTINGS[window.location.hostname] || DOMAIN_SETTINGS["payment-gateway-mutasi.vercel.app"]; document.title = s.name; document.getElementById('header-title').innerText = s.name; document.getElementById('header-logo').src = s.logo; }
        
        let state = { step: 1, totalAmount: 0, items: [], selectedMethod: 'qris', timeoutMinutes: 15, refId: "", activeQrisData: null, notifyUrl: "", merchantEmail: "" };
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        window.onload = function() {
            applyDomainSettings();
            const params = new URLSearchParams(window.location.search);
            state.returnUrl = params.get('return') || document.referrer || "";
            state.notifyUrl = params.get('notify') || "";
            state.refId = params.get('ref_id') || "";
            state.merchantEmail = params.get('merchant'); // <--- TANGKAP EMAIL MERCHANT
            
            if(params.get('store')) document.getElementById('header-title').innerText = decodeURIComponent(params.get('store'));
            const itemsEncoded = params.get('items');
            if (itemsEncoded) { try { state.items = JSON.parse(atob(itemsEncoded)); state.totalAmount = state.items.reduce((sum, item) => sum + (parseInt(item.p) || 0), 0); } catch (e) {} }
            if (state.totalAmount === 0 && params.get('price')) state.totalAmount = parseInt(params.get('price'));
            
            document.getElementById('customerWa').value = params.get('wa') || "-";
            document.getElementById('customerEmail').value = params.get('email') || "guest@mail.com";
            renderStep1();
        };

        window.selectMethod = (id) => { state.selectedMethod = id; updateVisualSelection(); };
        function updateVisualSelection() {
            ['qris', 'bcava', 'bni', 'seabank', 'jago', 'neobank'].forEach(id => {
                const el = document.getElementById('method-'+id); if(!el) return;
                const active = state.selectedMethod === id;
                el.className = `cursor-pointer relative p-3 rounded-2xl border transition-all duration-200 mb-3 flex items-center gap-4 ${active ? 'bg-slate-800 text-white ring-2 ring-slate-800' : 'bg-white hover:border-slate-300 border-slate-200'}`;
            });
        }

        function renderStep1() {
            const content = document.getElementById('app-content');
            const itemsHtml = state.items.map(i => `<div class="flex items-start gap-3 py-3 border-b border-dashed border-slate-100 last:border-0"><div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-500 flex items-center justify-center flex-shrink-0">üì¶</div><div class="flex-1 min-w-0"><p class="text-xs font-bold text-slate-700 truncate">${i.n}</p></div><span class="font-bold text-xs text-slate-800">${formatRupiah(i.p)}</span></div>`).join('');
            
            content.innerHTML = `
                <div class="px-1 py-2 fade-enter">
                    <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100 mb-6">
                        <div class="space-y-1 mb-3 max-h-[180px] overflow-y-auto pr-1 custom-scroll">${itemsHtml}</div>
                        <div class="mt-2 pt-4 border-t border-slate-100 flex justify-between items-center"><p class="text-[10px] font-bold text-slate-400 uppercase">Total Tagihan</p><span class="text-xl font-extrabold text-slate-900">${formatRupiah(state.totalAmount)}</span></div>
                    </div>
                    <div id="method-qris" onclick="selectMethod('qris')" class="cursor-pointer relative p-4 rounded-2xl transition-all duration-300 bg-white text-slate-700 border border-slate-200 mb-4"><h4 class="font-bold text-sm">QRIS (Otomatis)</h4><p class="text-[10px] opacity-80">Scan via GoPay, Dana, BCA</p></div>
                </div>`;
            document.getElementById('action-area').innerHTML = `<button onclick="processCheckout()" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-2xl shadow-xl transition-all">BAYAR SEKARANG</button>`;
            setTimeout(updateVisualSelection, 100);
        }

        async function processCheckout() {
            const btn = document.querySelector('#action-area button'); btn.innerHTML = "LOADING..."; btn.disabled = true;
            try {
                const data = { 
                    product_name: state.items.length > 1 ? `${state.items[0].n} & ${state.items.length - 1} lainnya` : state.items[0].n, 
                    price: state.totalAmount, 
                    customer_contact: document.getElementById('customerWa').value, 
                    customer_email: document.getElementById('customerEmail').value, 
                    method: state.selectedMethod, ref_id: state.refId, notify_url: state.notifyUrl,
                    merchant_email: state.merchantEmail, // <--- KIRIM EMAIL MERCHANT KE BACKEND
                    store_name: document.getElementById('header-title').innerText 
                };
                const res = await fetch('/api/checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
                const d = await res.json();
                if(d.status === 'success') { state.totalAmount = d.total_pay; if(d.qris_meta) state.activeQrisData = { image: d.qr_image, name: d.qris_meta.name, nmid: d.qris_meta.nmid }; renderStep2(d); } 
                else { alert(d.error); btn.innerHTML = "COBA LAGI"; btn.disabled = false; }
            } catch(e) { alert("Error koneksi"); btn.innerHTML = "COBA LAGI"; btn.disabled = false; }
        }

        function renderStep2(apiData) {
            const content = document.getElementById('app-content');
            content.innerHTML = `<div class="px-4 py-4 text-center fade-enter flex flex-col items-center"><div class="inline-flex items-center gap-2 px-3 py-1 bg-red-50 text-red-600 rounded-full text-[10px] font-bold mb-6 border border-red-100 animate-pulse">‚è≥ SISA WAKTU <span id="timer">--:--</span></div><img src="${apiData.qr_image}" class="w-64 h-64 border-2 border-slate-900 rounded-lg p-1 bg-white shadow-sm mb-4"><h2 class="text-3xl font-extrabold text-slate-800">Rp ${apiData.total_pay.toLocaleString('id-ID')}</h2><p class="text-xs text-slate-500 mt-2">Transfer tepat hingga 3 digit terakhir</p></div>`;
            document.getElementById('action-area').innerHTML = `<button onclick="location.reload()" class="w-full bg-white text-slate-400 font-bold py-4 rounded-2xl border border-slate-200">BATALKAN</button>`;
            startTimer(state.timeoutMinutes * 60); startCheckingStatus(apiData.order_id);
        }

        function startTimer(d) { let t=d; setInterval(() => { let m=parseInt(t/60,10), s=parseInt(t%60,10); document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`; if(--t<0) location.reload(); }, 1000); }
        function startCheckingStatus(id) { setInterval(async () => { try { const r = await fetch('/api/status?order_id='+id); const d = await r.json(); if(d.status === 'PAID') renderSuccess(); } catch(e){} }, 3000); }
        function renderSuccess() { document.getElementById('app-content').innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center"><div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center text-3xl mb-4">‚úÖ</div><h2 class="text-2xl font-bold">LUNAS!</h2><p class="text-sm text-slate-500">Terima kasih.</p></div>`; document.getElementById('action-area').classList.add('hidden'); setTimeout(() => window.location.href=state.returnUrl, 3000); }
    </script>
</body>
</html>
